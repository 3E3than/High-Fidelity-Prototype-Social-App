<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <title>List of Users</title>
</head>
<body>
<header>
    <button class="back-button" onclick="window.location.href='bar_info_page.html'">&lt;</button>
    <h1> Users Nearby </h1> 
    <button class="menu-button" onclick="toggleMenu()">&#9776;</button>
    <div class="menu-content" id="menuContent">
        <a href="bar_landing_page.html">Home</a>
        <a href="profile.html">Profile</a>
        <a href="settings.html">Settings</a>
        <a href="faq.html">FAQs</a>
        <a href="mission.html">Mission</a>
    </div>
</header>

<div class="matches-container">
    <button class="btn-custom matches-button" onclick="window.location.href='MatchesList.html'">Matches</button>
</div>

<div class="container">
    <div class="switch-container">
        <label>Friend Mode</label>
        <label class="switch">
            <input type="checkbox" id="friendModeToggle" onclick="toggleFriendMode()">
            <span class="slider"></span>
        </label>
        <label>AI Recommended</label>
        <label class="switch">
            <input type="checkbox" id="aiRecommendationToggle" onclick="toggleAIRecommendation()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="initial-profiles active" id="profilesContainer">
        <!-- Profiles will be dynamically loaded here -->
    </div>
    
    <div class="friend-mode" id="friendProfilesContainer">
        <!-- Friend mode profiles will be dynamically loaded here -->
    </div>
</div>
    
<div class="popup" id="profilePopup">
    <img src="" alt="Profile Photo" id="popupImg">
    <h2 id="popupName"></h2>
    <p id="popupDescription"></p>
    <button class="close-btn" onclick="closePopup()">Close</button>
</div>

<div id="heartPopup" class="heart-popup" style="display: none;">
    <!-- Pop-up content will be dynamically injected here -->
</div>

<div id="busyPopup" class="heart-popup" style="display: none;">
    <div class="popup-content">
        <button class="close-btn" onclick="closeBusyPopup()">√ó</button>
        <div class="popup-message">
            <span>üöÄ</span>
            <h2>They're Busy, try again later</h2>
        </div>
    </div>
</div>
    
<script>
    window.onload = (event) => {
        if (localStorage.getItem("photo")) {
          document.getElementById("currentUserImg").src = localStorage.getItem("photo");
        }
    }
    const currentUserProfile = {
        name: "Alex",
        img: "ProfileAlex.jpg", // Add the current user image here
        interests: ["Hiking", "Reading", "Cooking"],
        hobbies: ["Photography", "Traveling"],
        profession: "Software Engineer"
    };

    const otherUserProfiles = [
        { name: "Taylor", description: "Enjoys reading and gaming.", interests: ["Reading", "Gaming", "Cooking"], hobbies: ["Writing", "Traveling"], profession: "Writer", img: "Profile1.jpg" },
        { name: "Jamie", description: "Likes hiking and cooking.", interests: ["Hiking", "Cooking", "Music"], hobbies: ["Traveling", "Painting"], profession: "Graphic Designer", img: "Profile2.jpg" },
        { name: "Morgan", description: "Travels often and enjoys music.", interests: ["Hiking", "Reading", "Cooking"], hobbies: ["Photography", "Traveling"], profession: "Data Scientist", img: "Profile3.jpg" },
        { name: "James" , description: "Likes watching movies and running" , interests:["Movies" , "Running" , "Fitness"] , hobbies: ["Star Wars" , "Running"], profession: "Business Analyst" , img: "Profile1.jpg"},
        { name: "Cameron", description: "Tech enthusiast and coder.", interests: ["Programming", "Gaming", "Music"], hobbies: ["Robotics", "3D Printing"], profession: "Software Developer", img: "Profile1.jpg" },
        { name: "Charlie", description: "Fitness freak and health coach.", interests: ["Fitness", "Cooking", "Meditation"], hobbies: ["Yoga", "Cycling"], profession: "Personal Trainer", img: "Profile2.jpg" },
        { name: "Peyton", description: "Creative artist and designer.", interests: ["Painting", "Design", "Photography"], hobbies: ["Sketching", "Traveling"], profession: "Graphic Designer", img: "Profile1.jpg" }
    ];

    const friendUserProfiles = [
        { name: "Robin", description: "Nature lover and explorer.", interests: ["Hiking", "Nature", "Bird Watching"], hobbies: ["Photography", "Camping"], profession: "Environmental Scientist", img: "Profile2.jpg" },
        { name: "Jordan", description: "Tech enthusiast and startup founder.", interests: ["Programming", "Startups", "Gaming"], hobbies: ["Robotics", "AI Research"], profession: "Entrepreneur", img: "Profile3.jpg" },
        { name: "Alexis", description: "Musician and artist.", interests: ["Music", "Art", "Writing"], hobbies: ["Playing Guitar", "Painting"], profession: "Musician", img: "Profile1.jpg" }
    ];

    const heartState = {}; // To track heart icon state

    function toggleMenu() {
        var menuContent = document.getElementById('menuContent');
        menuContent.classList.toggle('show');
    }

    function toggleHeart(event) {
        event.stopPropagation(); // Prevent popup from appearing
        const heart = event.target;
        const profileDiv = heart.parentElement;
        const profileName = profileDiv.getAttribute('data-name');

        if (!heartState[profileName]) {
            heartState[profileName] = true;
            heart.classList.add('filled');
            if (profileName === 'Morgan' || profileName === 'Peyton') {
                showHeartPopup(profileName);
            }
        } else {
            heartState[profileName] = false;
            heart.classList.remove('filled');
        }
    }

    function showHeartPopup(name) {
        const profile = otherUserProfiles.find(profile => profile.name === name);
        const heartPopup = document.getElementById('heartPopup');
        heartPopup.innerHTML = `
            <div class="popup-content">
                <button class="close-btn" onclick="closeHeartPopup()">√ó</button>
                <div class="popup-users">
                    <div class="user-profile">
                        <img id="currentUserImg" src="${currentUserProfile.img}" alt="Current User Photo">
                        <h2 id="currentUserName">${currentUserProfile.name}</h2>
                    </div>
                    <div class="heart-icon">‚ù§Ô∏è</div>
                    <div class="user-profile">
                        <img id="targetUserImg" src="${profile.img}" alt="${profile.name}'s Photo">
                        <h2>${profile.name}</h2>
                    </div>
                </div>
                <div>
                    <button class="btn-custom" onclick="${name === 'Peyton' ? 'meetAtBar2()' : 'meetAtBar()'}">Meet at the bar?</button>
                    <button class="btn-custom" onclick="later()">Later</button>
                </div>
            </div>
        `;
        heartPopup.style.display = 'flex';
    }

    function meetAtBar() {
        window.location.href = 'MatchesList.html';
        // Simulate clicking invite button (can be adjusted based on actual functionality)
        localStorage.setItem("inviteClicked", "Morgan");
    }

    function meetAtBar2() {
        closeHeartPopup();
        showBusyPopup(); // Show the busy pop-up
    }

    function showBusyPopup() {
        const busyPopup = document.getElementById('busyPopup');
        busyPopup.style.display = 'flex';
    }

    function closeBusyPopup() {
        const busyPopup = document.getElementById('busyPopup');
        busyPopup.style.display = 'none';
    }

    function closeHeartPopup() {
    document.getElementById('heartPopup').style.display = 'none';
}

    function later() {
        closeHeartPopup();
    }

    function toggleFriendMode() {
        const profilesContainer = document.getElementById('profilesContainer');
        const friendModeToggle = document.getElementById('friendModeToggle');
        
        if (friendModeToggle.checked) {
            loadFriendProfiles();
        } else {
            loadInitialProfiles();
        }

        // Reapply heart states for the currently visible profiles
        applyHeartStates();
    }

    function toggleAIRecommendation() {
        const aiRecommendationToggle = document.getElementById('aiRecommendationToggle');
        if (aiRecommendationToggle.checked) {
            generateSortedProfiles();
        } else {
            loadInitialProfiles();
        }
    }

    function loadInitialProfiles() {
        const profilesContainer = document.getElementById('profilesContainer');
        profilesContainer.innerHTML = '';
        otherUserProfiles.forEach(profile => {
            const profileDiv = createProfileDiv(profile);
            profilesContainer.appendChild(profileDiv);
        });
        applyHeartStates();
    }

    function loadFriendProfiles() {
        const profilesContainer = document.getElementById('profilesContainer');
        profilesContainer.innerHTML = '';
        friendUserProfiles.forEach(profile => {
            const profileDiv = createProfileDiv(profile);
            profilesContainer.appendChild(profileDiv);
        });
        applyHeartStates();
    }

    async function generateSortedProfiles() {
        // Use fetch to call the Noggin API for sorted profiles
        const response = await fetch(
          'https://noggin.rea.gent/curved-rabbit-5970',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer rg_v1_4wgriw1jfbod0eub1pnab0dvshzoggz5c8kz_ngk',
            },
                body: JSON.stringify({
                    userProfile: JSON.stringify(currentUserProfile),
                    otherProfiles: JSON.stringify(otherUserProfiles)
                }),
            }
        );

        const sortedProfiles = await response.json();
        console.log("Sorted Profiles:", sortedProfiles);

        // Update otherUserProfiles with sorted profiles
        otherUserProfiles.length = 0;
        sortedProfiles.forEach(profile => otherUserProfiles.push(profile));

        // Display sorted profiles
        const profilesContainer = document.getElementById('profilesContainer');
        profilesContainer.innerHTML = '';
        sortedProfiles.forEach(profile => {
            const profileDiv = createProfileDiv(profile);
            profilesContainer.appendChild(profileDiv);
        });
        applyHeartStates();
    }

    function createProfileDiv(profile) {
        const profileDiv = document.createElement('div');
        profileDiv.classList.add('profile');
        profileDiv.setAttribute('data-name', profile.name);
        profileDiv.setAttribute('data-description', profile.description);
        profileDiv.setAttribute('data-img', profile.img);

        const img = document.createElement('img');
        img.src = profile.img;
        img.alt = 'User Photo';

        const descriptionDiv = document.createElement('div');
        descriptionDiv.classList.add('profile-description');

        const name = document.createElement('h2');
        name.textContent = profile.name;

        const description = document.createElement('p');
        description.textContent = profile.description;

        descriptionDiv.appendChild(name);
        descriptionDiv.appendChild(description);

        const heart = document.createElement('span');
        heart.classList.add('heart');
        heart.innerHTML = '&#9825;';
        heart.addEventListener('click', toggleHeart);

        profileDiv.appendChild(img);
        profileDiv.appendChild(descriptionDiv);
        profileDiv.appendChild(heart);

        profileDiv.addEventListener('click', function (event) {
            if (!event.target.classList.contains('heart')) {
                showPopup(profile);
            }
        });

        return profileDiv;
    }

    function applyHeartStates() {
        document.querySelectorAll('.profile').forEach(profileDiv => {
            const profileName = profileDiv.getAttribute('data-name');
            const heart = profileDiv.querySelector('.heart');
            if (heartState[profileName]) {
                heart.classList.add('filled');
            } else {
                heart.classList.remove('filled');
            }
        });
    }

    function showPopup(profile) {
        document.getElementById('popupName').innerText = profile.name;
        document.getElementById('popupDescription').innerText = profile.description;
        document.getElementById('popupImg').src = profile.img;
        document.getElementById('profilePopup').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('profilePopup').style.display = 'none';
    }

    // Load initial profiles on page load
    loadInitialProfiles();
</script>
</body>
</html>
